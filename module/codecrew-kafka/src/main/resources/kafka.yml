spring:
  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9094}
    client-id: ${spring.application.name}-${random.uuid} # 인스턴스 구분을 위해 랜덤값 추가

    producer:
      # [2] 데이터 안전 & 성능 밸런스
      acks: all
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      properties:
        enable.idempotence: true
        # 배치 전송을 위해 5ms 대기 (성능 튜닝 핵심)
        linger.ms: ${KAFKA_PRODUCER_LINGER_MS:5}
        # 한 번에 보낼 배치 크기 (기본 16KB -> 32KB로 증액 추천)
        batch.size: ${KAFKA_PRODUCER_BATCH_SIZE:32768}

    consumer:
      # [3] 그룹 ID: 환경 변수로 덮어쓰기 가능, 없으면 '앱이름-group'
      group-id: ${KAFKA_CONSUMER_GROUP_ID:${spring.application.name}-group}
      
      # 오프셋 정책: 배포 시 실수 방지를 위해 명시 (latest or earliest)
      auto-offset-reset: ${KAFKA_AUTO_OFFSET_RESET:latest}
      enable-auto-commit: false
      
      # 한 번에 가져올 개수: 처리 능력에 따라 조절 (기본 500)
      max-poll-records: ${KAFKA_CONSUMER_MAX_POLL_RECORDS:500}

      # [4] 안전한 역직렬화 (ErrorHandling + JSON)
      key-deserializer: org.springframework.kafka.support.serializer.ErrorHandlingDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.ErrorHandlingDeserializer
      properties:
        spring.deserializer.key.delegate.class: org.apache.kafka.common.serialization.StringDeserializer
        spring.deserializer.value.delegate.class: org.springframework.kafka.support.serializer.JsonDeserializer
        spring.json.trusted.packages: "*"
        spring.json.use.type.headers: false

    # [5] 성능 표준: 배치 처리 후 일괄 커밋
    listener:
      type: batch  # [핵심] 이게 있어야 자바에서 List<>로 받을 수 있음
      ack-mode: MANUAL